{"version":3,"sources":["../src/dev-server.ts","../src/lib/fs-utils.ts","../src/lib/package-root.ts","../src/lib/paths.ts","../src/lib/bindings.ts","../src/lib/prototypes.ts","../src/lib/superloop-data.ts","../src/lib/payload.ts","../src/lib/watch.ts"],"sourcesContent":["import { spawn } from \"node:child_process\";\nimport fs from \"node:fs/promises\";\nimport http from \"node:http\";\nimport path from \"node:path\";\n\nimport { fileExists } from \"./lib/fs-utils.js\";\nimport { resolvePackageRoot } from \"./lib/package-root.js\";\nimport { resolveLoopDir, resolveLoopsRoot, resolvePrototypesRoot } from \"./lib/paths.js\";\nimport { buildPrototypesPayload } from \"./lib/payload.js\";\nimport { watchPaths } from \"./lib/watch.js\";\n\nexport type DevServerOptions = {\n  repoRoot: string;\n  loopId?: string;\n  port: number;\n  host: string;\n  open: boolean;\n};\n\ntype SseClient = http.ServerResponse;\n\nexport async function startDevServer(options: DevServerOptions): Promise<void> {\n  const packageRoot = resolvePackageRoot(import.meta.url);\n  const webRoot = path.join(packageRoot, \"src\", \"web\");\n  const distWebRoot = path.join(packageRoot, \"dist\", \"web\");\n  const indexHtmlPath = path.join(webRoot, \"index.html\");\n\n  const clients = new Set<SseClient>();\n\n  const server = http.createServer(async (req, res) => {\n    if (!req.url) {\n      res.writeHead(400);\n      res.end();\n      return;\n    }\n\n    const url = new URL(req.url, `http://${req.headers.host ?? \"localhost\"}`);\n\n    if (url.pathname === \"/events\") {\n      res.writeHead(200, {\n        \"Content-Type\": \"text/event-stream\",\n        \"Cache-Control\": \"no-cache\",\n        Connection: \"keep-alive\",\n      });\n      res.write(\"\\n\");\n      clients.add(res);\n      req.on(\"close\", () => {\n        clients.delete(res);\n      });\n      return;\n    }\n\n    if (url.pathname === \"/api/prototypes\") {\n      const payload = await buildPrototypesPayload({\n        repoRoot: options.repoRoot,\n        loopId: options.loopId,\n      });\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\n      res.end(JSON.stringify(payload));\n      return;\n    }\n\n    if (url.pathname === \"/\" || url.pathname === \"/index.html\") {\n      const html = await fs.readFile(indexHtmlPath, \"utf8\");\n      res.writeHead(200, { \"Content-Type\": \"text/html; charset=utf-8\" });\n      res.end(html);\n      return;\n    }\n\n    if (url.pathname.startsWith(\"/main\")) {\n      const filePath = path.join(distWebRoot, url.pathname.replace(\"/\", \"\"));\n      if (!(await fileExists(filePath))) {\n        res.writeHead(503, { \"Content-Type\": \"text/plain\" });\n        res.end(\"Web bundle not ready. Waiting for build...\");\n        return;\n      }\n      const contentType = url.pathname.endsWith(\".map\") ? \"application/json\" : \"text/javascript\";\n      res.writeHead(200, { \"Content-Type\": contentType });\n      res.end(await fs.readFile(filePath));\n      return;\n    }\n\n    res.writeHead(404, { \"Content-Type\": \"text/plain\" });\n    res.end(\"Not found\");\n  });\n\n  await new Promise<void>((resolve) => {\n    server.listen(options.port, options.host, () => resolve());\n  });\n\n  const address = `http://${options.host}:${options.port}`;\n  console.log(`Superloop UI dev server running at ${address}`);\n\n  if (options.open) {\n    openBrowser(address);\n  }\n\n  const buildProcess = spawn(\"bunx\", [\"tsup\", \"--watch\", \"--config\", \"tsup.config.ts\"], {\n    cwd: packageRoot,\n    stdio: \"inherit\",\n  });\n\n  const broadcast = async () => {\n    const payload = await buildPrototypesPayload({\n      repoRoot: options.repoRoot,\n      loopId: options.loopId,\n    });\n    broadcastEvent(clients, \"data\", payload);\n  };\n\n  const prototypesRoot = resolvePrototypesRoot(options.repoRoot);\n  const loopsRoot = resolveLoopsRoot(options.repoRoot);\n  const loopDir = options.loopId ? resolveLoopDir(options.repoRoot, options.loopId) : undefined;\n\n  await fs.mkdir(prototypesRoot, { recursive: true });\n\n  const dataWatcher = watchPaths(\n    [prototypesRoot, loopsRoot, loopDir].filter((value): value is string => Boolean(value)),\n    () => {\n      void broadcast();\n    },\n  );\n\n  const bundleWatcher = watchPaths([distWebRoot], () => {\n    broadcastEvent(clients, \"reload\", { reason: \"bundle\" });\n  });\n\n  const shutdown = () => {\n    dataWatcher.close();\n    bundleWatcher.close();\n    for (const client of clients) {\n      client.end();\n    }\n    buildProcess.kill();\n    server.close();\n  };\n\n  process.on(\"SIGINT\", shutdown);\n  process.on(\"SIGTERM\", shutdown);\n}\n\nfunction broadcastEvent(clients: Set<SseClient>, event: string, payload: unknown) {\n  const body = `event: ${event}\\ndata: ${JSON.stringify(payload)}\\n\\n`;\n  for (const client of clients) {\n    client.write(body);\n  }\n}\n\nfunction openBrowser(url: string) {\n  const platform = process.platform;\n  if (platform === \"darwin\") {\n    spawn(\"open\", [url], { stdio: \"ignore\" });\n    return;\n  }\n  if (platform === \"win32\") {\n    spawn(\"cmd\", [\"/c\", \"start\", url], { stdio: \"ignore\" });\n    return;\n  }\n  spawn(\"xdg-open\", [url], { stdio: \"ignore\" });\n}\n","import fs from \"node:fs/promises\";\n\nexport async function fileExists(path: string): Promise<boolean> {\n  try {\n    await fs.access(path);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport async function readJson<T>(path: string): Promise<T | null> {\n  try {\n    const raw = await fs.readFile(path, \"utf8\");\n    return JSON.parse(raw) as T;\n  } catch {\n    return null;\n  }\n}\n","import path from \"node:path\";\nimport { fileURLToPath } from \"node:url\";\n\nexport function resolvePackageRoot(metaUrl: string): string {\n  const filename = fileURLToPath(metaUrl);\n  const dir = path.dirname(filename);\n  return path.resolve(dir, \"..\");\n}\n","import path from \"node:path\";\n\nexport const SUPERLOOP_DIR = \".superloop\";\nexport const UI_PROTOTYPES_DIR = path.join(SUPERLOOP_DIR, \"ui\", \"prototypes\");\nexport const LOOPS_DIR = path.join(SUPERLOOP_DIR, \"loops\");\n\nexport function resolveRepoRoot(repoRoot?: string): string {\n  return repoRoot ? path.resolve(repoRoot) : process.cwd();\n}\n\nexport function resolvePrototypesRoot(repoRoot: string): string {\n  return path.join(repoRoot, UI_PROTOTYPES_DIR);\n}\n\nexport function resolveLoopsRoot(repoRoot: string): string {\n  return path.join(repoRoot, LOOPS_DIR);\n}\n\nexport function resolveLoopDir(repoRoot: string, loopId: string): string {\n  return path.join(resolveLoopsRoot(repoRoot), loopId);\n}\n","export type BindingRecord = Record<string, unknown>;\n\nexport function injectBindings(template: string, data: BindingRecord): string {\n  return template.replace(/\\{\\{\\s*([a-zA-Z0-9_.-]+)\\s*\\}\\}/g, (match, key) => {\n    const value = resolvePath(data, key);\n    if (value === undefined || value === null) {\n      return match;\n    }\n    if (typeof value === \"object\") {\n      return JSON.stringify(value);\n    }\n    return String(value);\n  });\n}\n\nfunction resolvePath(data: BindingRecord, key: string): unknown {\n  if (!key.includes(\".\")) {\n    return data[key];\n  }\n  return key.split(\".\").reduce<unknown>((acc, segment) => {\n    if (acc && typeof acc === \"object\" && segment in (acc as Record<string, unknown>)) {\n      return (acc as Record<string, unknown>)[segment];\n    }\n    return undefined;\n  }, data);\n}\n","import fs from \"node:fs/promises\";\nimport path from \"node:path\";\n\nimport { fileExists, readJson } from \"./fs-utils.js\";\nimport { resolvePrototypesRoot } from \"./paths.js\";\n\nexport type PrototypeVersion = {\n  id: string;\n  filename: string;\n  path: string;\n  createdAt: string;\n  content: string;\n};\n\nexport type PrototypeView = {\n  name: string;\n  description?: string;\n  versions: PrototypeVersion[];\n  latest: PrototypeVersion;\n};\n\ntype PrototypeMeta = {\n  description?: string;\n  prompt?: string;\n  createdAt?: string;\n  updatedAt?: string;\n};\n\nconst VERSION_EXTENSION = \".txt\";\nconst META_FILENAME = \"meta.json\";\nconst TIMESTAMP_PATTERN = /^(\\d{8}-\\d{6})/;\n\nexport function createTimestampId(date = new Date()): string {\n  const pad = (value: number) => value.toString().padStart(2, \"0\");\n  const year = date.getFullYear();\n  const month = pad(date.getMonth() + 1);\n  const day = pad(date.getDate());\n  const hours = pad(date.getHours());\n  const minutes = pad(date.getMinutes());\n  const seconds = pad(date.getSeconds());\n  return `${year}${month}${day}-${hours}${minutes}${seconds}`;\n}\n\nexport function formatTimestamp(date: Date): string {\n  const pad = (value: number) => value.toString().padStart(2, \"0\");\n  const year = date.getFullYear();\n  const month = pad(date.getMonth() + 1);\n  const day = pad(date.getDate());\n  const hours = pad(date.getHours());\n  const minutes = pad(date.getMinutes());\n  const seconds = pad(date.getSeconds());\n  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;\n}\n\nexport async function listPrototypes(repoRoot: string): Promise<PrototypeView[]> {\n  const root = resolvePrototypesRoot(repoRoot);\n  if (!(await fileExists(root))) {\n    return [];\n  }\n\n  const entries = await fs.readdir(root, { withFileTypes: true });\n  const viewsByName = new Map<string, PrototypeView>();\n\n  for (const entry of entries) {\n    if (entry.isDirectory()) {\n      const view = await readViewDirectory(root, entry.name);\n      if (view) {\n        viewsByName.set(view.name, view);\n      }\n    }\n  }\n\n  for (const entry of entries) {\n    if (!entry.isFile() || !entry.name.endsWith(VERSION_EXTENSION)) {\n      continue;\n    }\n\n    const viewName = path.basename(entry.name, VERSION_EXTENSION);\n    const filePath = path.join(root, entry.name);\n    const version = await readVersionFile(filePath, entry.name);\n    const existing = viewsByName.get(viewName);\n\n    if (existing) {\n      if (!existing.versions.some((item) => item.filename === entry.name)) {\n        existing.versions.push(version);\n      }\n      existing.versions.sort((a, b) => a.createdAt.localeCompare(b.createdAt));\n      existing.latest = existing.versions[existing.versions.length - 1];\n    } else {\n      viewsByName.set(viewName, {\n        name: viewName,\n        versions: [version],\n        latest: version,\n      });\n    }\n  }\n\n  return Array.from(viewsByName.values()).sort((a, b) => a.name.localeCompare(b.name));\n}\n\nexport async function createPrototypeVersion(params: {\n  repoRoot: string;\n  viewName: string;\n  content: string;\n  description?: string;\n  prompt?: string;\n}): Promise<PrototypeVersion> {\n  const root = resolvePrototypesRoot(params.repoRoot);\n  const viewDir = path.join(root, params.viewName);\n  await fs.mkdir(viewDir, { recursive: true });\n\n  const timestampId = createTimestampId();\n  const filename = `${timestampId}${VERSION_EXTENSION}`;\n  const filePath = path.join(viewDir, filename);\n  await fs.writeFile(filePath, params.content, \"utf8\");\n\n  const metaPath = path.join(viewDir, META_FILENAME);\n  const meta = (await readJson<PrototypeMeta>(metaPath)) ?? {};\n  const now = new Date().toISOString();\n  const nextMeta: PrototypeMeta = {\n    description: params.description ?? meta.description,\n    prompt: params.prompt ?? meta.prompt,\n    createdAt: meta.createdAt ?? now,\n    updatedAt: now,\n  };\n  await fs.writeFile(metaPath, JSON.stringify(nextMeta, null, 2), \"utf8\");\n\n  return {\n    id: timestampId,\n    filename,\n    path: filePath,\n    createdAt: formatTimestamp(new Date()),\n    content: params.content,\n  };\n}\n\nexport async function readLatestPrototype(params: {\n  repoRoot: string;\n  viewName: string;\n}): Promise<PrototypeView | null> {\n  const root = resolvePrototypesRoot(params.repoRoot);\n  const viewDir = path.join(root, params.viewName);\n  const view = (await fileExists(viewDir)) ? await readViewDirectory(root, params.viewName) : null;\n\n  const standaloneName = `${params.viewName}${VERSION_EXTENSION}`;\n  const standalonePath = path.join(root, standaloneName);\n  if (await fileExists(standalonePath)) {\n    const version = await readVersionFile(standalonePath, standaloneName);\n    if (view) {\n      if (!view.versions.some((item) => item.filename === standaloneName)) {\n        view.versions.push(version);\n      }\n      view.versions.sort((a, b) => a.createdAt.localeCompare(b.createdAt));\n      view.latest = view.versions[view.versions.length - 1];\n      return view;\n    }\n\n    return {\n      name: params.viewName,\n      versions: [version],\n      latest: version,\n    };\n  }\n\n  return view ?? null;\n}\n\nasync function readViewDirectory(root: string, viewName: string): Promise<PrototypeView | null> {\n  const viewDir = path.join(root, viewName);\n  const entries = await fs.readdir(viewDir, { withFileTypes: true });\n  const versions: PrototypeVersion[] = [];\n  let description: string | undefined;\n\n  for (const entry of entries) {\n    if (entry.isFile() && entry.name === META_FILENAME) {\n      const meta = await readJson<PrototypeMeta>(path.join(viewDir, entry.name));\n      description = meta?.description;\n      continue;\n    }\n\n    if (entry.isFile() && entry.name.endsWith(VERSION_EXTENSION)) {\n      const filePath = path.join(viewDir, entry.name);\n      const version = await readVersionFile(filePath, entry.name);\n      versions.push(version);\n    }\n  }\n\n  if (versions.length === 0) {\n    return null;\n  }\n\n  versions.sort((a, b) => a.createdAt.localeCompare(b.createdAt));\n  const latest = versions[versions.length - 1];\n\n  return {\n    name: viewName,\n    description,\n    versions,\n    latest,\n  };\n}\n\nfunction readVersionId(filename: string, fallbackDate: Date): string {\n  const match = filename.match(TIMESTAMP_PATTERN);\n  if (match?.[1]) {\n    return match[1];\n  }\n  return createTimestampId(fallbackDate);\n}\n\nasync function readVersionFile(filePath: string, filename: string): Promise<PrototypeVersion> {\n  const stats = await fs.stat(filePath);\n  const content = await fs.readFile(filePath, \"utf8\");\n  const versionId = readVersionId(filename, stats.mtime);\n  const createdAt = formatTimestamp(resolveTimestamp(versionId, stats.mtime));\n\n  return {\n    id: versionId,\n    filename,\n    path: filePath,\n    createdAt,\n    content,\n  };\n}\n\nfunction resolveTimestamp(versionId: string, fallbackDate: Date): Date {\n  const parsed = parseTimestampId(versionId);\n  return parsed ?? fallbackDate;\n}\n\nfunction parseTimestampId(versionId: string): Date | null {\n  const match = versionId.match(TIMESTAMP_PATTERN);\n  if (!match?.[1]) {\n    return null;\n  }\n\n  const id = match[1];\n  const year = Number(id.slice(0, 4));\n  const month = Number(id.slice(4, 6));\n  const day = Number(id.slice(6, 8));\n  const hours = Number(id.slice(9, 11));\n  const minutes = Number(id.slice(11, 13));\n  const seconds = Number(id.slice(13, 15));\n  const date = new Date(year, month - 1, day, hours, minutes, seconds);\n\n  if (Number.isNaN(date.getTime())) {\n    return null;\n  }\n\n  return date;\n}\n","import fs from \"node:fs/promises\";\nimport path from \"node:path\";\n\nimport { fileExists, readJson } from \"./fs-utils.js\";\nimport { resolveLoopDir, resolveLoopsRoot } from \"./paths.js\";\n\ntype RunSummaryEntry = {\n  iteration?: number;\n  started_at?: string;\n  ended_at?: string;\n  promise?: {\n    expected?: string;\n    text?: string;\n    matched?: boolean;\n  };\n  gates?: {\n    tests?: string;\n    checklist?: string;\n    evidence?: string;\n    approval?: string;\n  };\n  completion_ok?: boolean;\n};\n\ntype RunSummary = {\n  loop_id?: string;\n  updated_at?: string;\n  entries?: RunSummaryEntry[];\n};\n\ntype TestStatus = {\n  ok?: boolean;\n  skipped?: boolean;\n};\n\ntype ChecklistStatus = {\n  ok?: boolean;\n};\n\ntype LoopEvent = {\n  timestamp?: string;\n  event?: string;\n  iteration?: number;\n  data?: Record<string, unknown>;\n};\n\ntype EventFallback = {\n  iteration?: string;\n  promise?: string;\n  promise_matched?: string;\n  test_status?: string;\n  checklist_status?: string;\n  evidence_status?: string;\n  approval_status?: string;\n  completion_ok?: string;\n  started_at?: string;\n  ended_at?: string;\n};\n\nexport type SuperloopDataPayload = {\n  loopId?: string;\n  data: Record<string, string>;\n};\n\nexport async function resolveLoopId(repoRoot: string, preferred?: string): Promise<string | null> {\n  const loopsRoot = resolveLoopsRoot(repoRoot);\n  if (!(await fileExists(loopsRoot))) {\n    return null;\n  }\n\n  if (preferred) {\n    const loopDir = resolveLoopDir(repoRoot, preferred);\n    if (await fileExists(loopDir)) {\n      return preferred;\n    }\n  }\n\n  if (process.env.SUPERLOOP_LOOP_ID) {\n    const envId = process.env.SUPERLOOP_LOOP_ID;\n    if (envId && (await fileExists(resolveLoopDir(repoRoot, envId)))) {\n      return envId;\n    }\n  }\n\n  const entries = await fs.readdir(loopsRoot, { withFileTypes: true });\n  const loopDirs = entries.filter((entry) => entry.isDirectory());\n  if (loopDirs.length === 0) {\n    return null;\n  }\n\n  const withStats = await Promise.all(\n    loopDirs.map(async (entry) => {\n      const dirPath = path.join(loopsRoot, entry.name);\n      const stats = await fs.stat(dirPath);\n      return { name: entry.name, mtimeMs: stats.mtimeMs };\n    }),\n  );\n\n  withStats.sort((a, b) => b.mtimeMs - a.mtimeMs);\n  return withStats[0]?.name ?? null;\n}\n\nexport async function loadSuperloopData(params: {\n  repoRoot: string;\n  loopId?: string;\n}): Promise<SuperloopDataPayload> {\n  const loopId = await resolveLoopId(params.repoRoot, params.loopId);\n  if (!loopId) {\n    return { data: {} };\n  }\n\n  const loopDir = resolveLoopDir(params.repoRoot, loopId);\n  const runSummary = await readJson<RunSummary>(path.join(loopDir, \"run-summary.json\"));\n  const testStatus = await readJson<TestStatus>(path.join(loopDir, \"test-status.json\"));\n  const checklistStatus = await readJson<ChecklistStatus>(\n    path.join(loopDir, \"checklist-status.json\"),\n  );\n  const eventFallback = await loadEventFallback(loopDir);\n\n  const entry = runSummary?.entries?.[runSummary.entries.length - 1];\n  const data: Record<string, string> = {\n    loop_id: loopId,\n    updated_at: runSummary?.updated_at ?? new Date().toISOString(),\n  };\n\n  if (entry?.iteration !== undefined) {\n    data.iteration = String(entry.iteration);\n  }\n\n  if (entry?.promise?.text || entry?.promise?.expected) {\n    data.promise = entry.promise.text ?? entry.promise.expected ?? \"\";\n  }\n\n  if (entry?.promise?.matched !== undefined) {\n    data.promise_matched = entry.promise.matched ? \"true\" : \"false\";\n  }\n\n  if (entry?.gates?.tests) {\n    data.test_status = entry.gates.tests;\n  } else if (testStatus && typeof testStatus.ok === \"boolean\") {\n    data.test_status = testStatus.ok ? (testStatus.skipped ? \"skipped\" : \"ok\") : \"failed\";\n  }\n\n  if (entry?.gates?.checklist) {\n    data.checklist_status = entry.gates.checklist;\n  } else if (typeof checklistStatus?.ok === \"boolean\") {\n    data.checklist_status = checklistStatus.ok ? \"ok\" : \"failed\";\n  }\n\n  if (entry?.gates?.evidence) {\n    data.evidence_status = entry.gates.evidence;\n  }\n\n  if (entry?.gates?.approval) {\n    data.approval_status = entry.gates.approval;\n  }\n\n  if (entry?.completion_ok !== undefined) {\n    data.completion_ok = entry.completion_ok ? \"true\" : \"false\";\n  }\n\n  if (entry?.started_at) {\n    data.started_at = entry.started_at;\n  }\n\n  if (entry?.ended_at) {\n    data.ended_at = entry.ended_at;\n  }\n\n  applyEventFallback(data, eventFallback);\n  return { loopId, data };\n}\n\nfunction applyEventFallback(data: Record<string, string>, fallback: EventFallback) {\n  const assignIfMissing = (key: keyof EventFallback) => {\n    const value = fallback[key];\n    if (value !== undefined && data[key] === undefined) {\n      data[key] = value;\n    }\n  };\n\n  assignIfMissing(\"iteration\");\n  assignIfMissing(\"promise\");\n  assignIfMissing(\"promise_matched\");\n  assignIfMissing(\"test_status\");\n  assignIfMissing(\"checklist_status\");\n  assignIfMissing(\"evidence_status\");\n  assignIfMissing(\"approval_status\");\n  assignIfMissing(\"completion_ok\");\n  assignIfMissing(\"started_at\");\n  assignIfMissing(\"ended_at\");\n}\n\nasync function loadEventFallback(loopDir: string): Promise<EventFallback> {\n  const eventsPath = path.join(loopDir, \"events.jsonl\");\n  if (!(await fileExists(eventsPath))) {\n    return {};\n  }\n\n  let raw: string;\n  try {\n    raw = await fs.readFile(eventsPath, \"utf8\");\n  } catch {\n    return {};\n  }\n\n  const lines = raw.trim().split(\"\\n\");\n  const fallback: EventFallback = {};\n  const pending = new Set<keyof EventFallback>([\n    \"iteration\",\n    \"promise\",\n    \"promise_matched\",\n    \"test_status\",\n    \"checklist_status\",\n    \"evidence_status\",\n    \"approval_status\",\n    \"completion_ok\",\n    \"started_at\",\n    \"ended_at\",\n  ]);\n\n  for (let index = lines.length - 1; index >= 0; index -= 1) {\n    const line = lines[index]?.trim();\n    if (!line) {\n      continue;\n    }\n\n    let event: LoopEvent;\n    try {\n      event = JSON.parse(line) as LoopEvent;\n    } catch {\n      continue;\n    }\n\n    if (pending.has(\"iteration\") && typeof event.iteration === \"number\") {\n      fallback.iteration = String(event.iteration);\n      pending.delete(\"iteration\");\n    }\n\n    const data = isRecord(event.data) ? event.data : {};\n\n    if (event.event === \"promise_checked\") {\n      if (pending.has(\"promise\")) {\n        const text = readString(data.text);\n        const expected = readString(data.expected);\n        if (text || expected) {\n          fallback.promise = text ?? expected;\n          pending.delete(\"promise\");\n        }\n      }\n\n      if (pending.has(\"promise_matched\")) {\n        const matched = readBoolean(data.matched);\n        if (matched !== undefined) {\n          fallback.promise_matched = matched ? \"true\" : \"false\";\n          pending.delete(\"promise_matched\");\n        }\n      }\n    }\n\n    if (event.event === \"tests_end\" && pending.has(\"test_status\")) {\n      const status = readString(data.status);\n      if (status) {\n        fallback.test_status = status;\n        pending.delete(\"test_status\");\n      }\n    }\n\n    if (event.event === \"checklist_end\" && pending.has(\"checklist_status\")) {\n      const status = readString(data.status);\n      if (status) {\n        fallback.checklist_status = status;\n        pending.delete(\"checklist_status\");\n      }\n    }\n\n    if (event.event === \"evidence_end\" && pending.has(\"evidence_status\")) {\n      const status = readString(data.status);\n      if (status) {\n        fallback.evidence_status = status;\n        pending.delete(\"evidence_status\");\n      }\n    }\n\n    if (event.event === \"gates_evaluated\") {\n      if (pending.has(\"test_status\")) {\n        const status = readString(data.tests);\n        if (status) {\n          fallback.test_status = status;\n          pending.delete(\"test_status\");\n        }\n      }\n\n      if (pending.has(\"checklist_status\")) {\n        const status = readString(data.checklist);\n        if (status) {\n          fallback.checklist_status = status;\n          pending.delete(\"checklist_status\");\n        }\n      }\n\n      if (pending.has(\"evidence_status\")) {\n        const status = readString(data.evidence);\n        if (status) {\n          fallback.evidence_status = status;\n          pending.delete(\"evidence_status\");\n        }\n      }\n\n      if (pending.has(\"approval_status\")) {\n        const status = readString(data.approval);\n        if (status) {\n          fallback.approval_status = status;\n          pending.delete(\"approval_status\");\n        }\n      }\n    }\n\n    if (event.event === \"iteration_start\" && pending.has(\"started_at\")) {\n      const startedAt = readString(data.started_at) ?? readString(event.timestamp);\n      if (startedAt) {\n        fallback.started_at = startedAt;\n        pending.delete(\"started_at\");\n      }\n    }\n\n    if (event.event === \"iteration_end\") {\n      if (pending.has(\"ended_at\")) {\n        const endedAt = readString(data.ended_at) ?? readString(event.timestamp);\n        if (endedAt) {\n          fallback.ended_at = endedAt;\n          pending.delete(\"ended_at\");\n        }\n      }\n\n      if (pending.has(\"completion_ok\")) {\n        const completion = readBoolean(data.completion);\n        if (completion !== undefined) {\n          fallback.completion_ok = completion ? \"true\" : \"false\";\n          pending.delete(\"completion_ok\");\n        }\n      }\n    }\n\n    if (pending.size === 0) {\n      break;\n    }\n  }\n\n  return fallback;\n}\n\nfunction isRecord(value: unknown): value is Record<string, unknown> {\n  return Boolean(value) && typeof value === \"object\" && !Array.isArray(value);\n}\n\nfunction readString(value: unknown): string | undefined {\n  return typeof value === \"string\" && value.trim() ? value : undefined;\n}\n\nfunction readBoolean(value: unknown): boolean | undefined {\n  return typeof value === \"boolean\" ? value : undefined;\n}\n","import { injectBindings } from \"./bindings.js\";\nimport { type PrototypeView, listPrototypes } from \"./prototypes.js\";\nimport { loadSuperloopData } from \"./superloop-data.js\";\n\nexport type RenderedPrototypeVersion = {\n  id: string;\n  filename: string;\n  path: string;\n  createdAt: string;\n  content: string;\n  rendered: string;\n};\n\nexport type RenderedPrototypeView = {\n  name: string;\n  description?: string;\n  versions: RenderedPrototypeVersion[];\n  latest: RenderedPrototypeVersion;\n};\n\nexport type PrototypesPayload = {\n  views: RenderedPrototypeView[];\n  loopId?: string;\n  data: Record<string, string>;\n  updatedAt: string;\n};\n\nexport async function buildPrototypesPayload(params: {\n  repoRoot: string;\n  loopId?: string;\n}): Promise<PrototypesPayload> {\n  const [views, superloop] = await Promise.all([\n    listPrototypes(params.repoRoot),\n    loadSuperloopData({ repoRoot: params.repoRoot, loopId: params.loopId }),\n  ]);\n\n  const renderedViews = views.map((view) => renderView(view, superloop.data));\n\n  return {\n    views: renderedViews,\n    loopId: superloop.loopId,\n    data: superloop.data,\n    updatedAt: new Date().toISOString(),\n  };\n}\n\nfunction renderView(view: PrototypeView, data: Record<string, string>): RenderedPrototypeView {\n  const versions = view.versions.map((version) => ({\n    ...version,\n    rendered: injectBindings(version.content, data),\n  }));\n  const latest = versions[versions.length - 1];\n\n  return {\n    name: view.name,\n    description: view.description,\n    versions,\n    latest,\n  };\n}\n","import fs from \"node:fs\";\nimport path from \"node:path\";\n\nexport type WatchHandle = {\n  close: () => void;\n};\n\nexport function watchPaths(paths: string[], onChange: () => void): WatchHandle {\n  const watchers: fs.FSWatcher[] = [];\n  const notify = debounce(onChange, 30);\n  const watchedDirs = new Set<string>();\n\n  function handleChange(dir: string, filename?: string | Buffer | null) {\n    notify();\n\n    if (!filename) {\n      return;\n    }\n\n    const name = filename.toString();\n    if (!name) {\n      return;\n    }\n\n    const fullPath = path.join(dir, name);\n    if (watchedDirs.has(fullPath)) {\n      return;\n    }\n\n    try {\n      if (fs.existsSync(fullPath) && fs.statSync(fullPath).isDirectory()) {\n        scanDirs(fullPath);\n      }\n    } catch {\n      // Ignore transient filesystem errors.\n    }\n  }\n\n  function watchDir(dir: string) {\n    if (watchedDirs.has(dir) || !fs.existsSync(dir)) {\n      return;\n    }\n\n    try {\n      const watcher = fs.watch(dir, (_event, filename) => {\n        handleChange(dir, filename);\n      });\n      watchers.push(watcher);\n      watchedDirs.add(dir);\n    } catch {\n      // Ignore directories that cannot be watched on this platform.\n    }\n  }\n\n  function scanDirs(root: string) {\n    if (!fs.existsSync(root)) {\n      return;\n    }\n\n    watchDir(root);\n\n    try {\n      const entries = fs.readdirSync(root, { withFileTypes: true });\n      for (const entry of entries) {\n        if (entry.isDirectory()) {\n          scanDirs(path.join(root, entry.name));\n        }\n      }\n    } catch {\n      // Ignore directories we cannot traverse.\n    }\n  }\n\n  for (const watchPath of paths) {\n    if (!fs.existsSync(watchPath)) {\n      continue;\n    }\n\n    try {\n      const watcher = fs.watch(watchPath, { recursive: true }, () => {\n        notify();\n      });\n      watchers.push(watcher);\n    } catch {\n      scanDirs(watchPath);\n    }\n  }\n\n  return {\n    close: () => {\n      for (const watcher of watchers) {\n        watcher.close();\n      }\n    },\n  };\n}\n\nfunction debounce(callback: () => void, waitMs: number): () => void {\n  let timeout: NodeJS.Timeout | null = null;\n  return () => {\n    if (timeout) {\n      clearTimeout(timeout);\n    }\n    timeout = setTimeout(() => {\n      timeout = null;\n      callback();\n    }, waitMs);\n  };\n}\n"],"mappings":"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","names":["fs","path","path","path","path","fs","path","fs","path","path","fs","fs","path","fs","path","fs","path","path","fs"]}